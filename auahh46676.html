<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>FM Live Streaming + Visualizer</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  :root {
    --card-bg: #fff;
    --text-color: #111;
    --muted: #666;
    --overlay-bg: rgba(0,0,0,0.75);
    --live-bg: #fff;
    --page-bg: #f0f2f5;
  }
  [data-theme="dark"] {
    --card-bg: #1a1a1a;
    --text-color: #f5f5f5;
    --muted: #aaa;
    --overlay-bg: rgba(0,0,0,0.85);
    --live-bg: #2a2a2a;
    --page-bg: #0e0e0e;
  }
  body {
    display: flex;justify-content: center;align-items: center;min-height: 100vh;
    background: var(--page-bg);margin: 0;
    font-family: 'Poppins', system-ui, Segoe UI, Roboto, Helvetica, Arial;
    color: var(--text-color);
  }
  .fm-player {
    position: relative;display: flex;flex-direction: column;gap: 12px;
    background: var(--card-bg);border-radius: 16px;padding: 16px;
    max-width: 720px;width: 92%;box-shadow: 0 8px 30px rgba(0,0,0,0.07);
  }
  .top-bar {display:flex;justify-content:space-between;align-items:center;position:relative;min-height:30px;}
  .left-controls {display:flex;align-items:center;gap:10px;}
  .theme-toggle {width:50px;height:24px;background:#ddd;border-radius:50px;position:relative;cursor:pointer;box-shadow:inset 0 2px 6px rgba(0,0,0,0.2);transition:background 0.3s;}
  .theme-toggle::before {
    content:"üåû";position:absolute;top:2px;left:2px;width:20px;height:20px;display:flex;justify-content:center;align-items:center;font-size:14px;background:white;border-radius:50%;box-shadow:0 1px 4px rgba(0,0,0,0.2);transition:all 0.3s;
  }
  body[data-theme="dark"] .theme-toggle {background:#444;}
  body[data-theme="dark"] .theme-toggle::before {content:"üåô";transform:translateX(26px);background:#222;}
  .live-card {background:var(--live-bg);border-radius:8px;box-shadow:0 2px 6px rgba(0,0,0,0.15);padding:4px 10px;display:none;align-items:center;gap:6px;font-size:13px;font-weight:600;color:red;white-space:nowrap;}
  .dot {width:6px;height:6px;background:red;border-radius:50%;animation:blink 1s infinite;}
  .controls {display:flex;flex-direction:column;gap:6px;margin-top:8px;}
  .title {font-weight:700;font-size:22px;letter-spacing:0.5px;}
  .subtitle-marquee {font-size:14px;color:var(--muted);white-space:nowrap;overflow:hidden;position:relative;}
  .subtitle-marquee span {display:inline-block;padding-left:100%;animation:marquee 10s linear infinite;}
  @keyframes marquee {0%{transform:translateX(0)}100%{transform:translateX(-100%)}}
  button {padding:10px 14px;border-radius:10px;border:1px solid #ddd;background:#fafafa;cursor:pointer;font-weight:700;}
  input[type=range] {width:120px;}
  .viz-wrap {position:relative;display:flex;flex-direction:column;gap:10px;align-items:center;width:100%;}
  canvas {width:100%;height:80px;border-radius:10px;background:linear-gradient(180deg,#0f1724 0%, #071024 100%);display:block;}
  .overlay-off {position:absolute;top:0;left:0;width:100%;height:100%;background:var(--overlay-bg);color:white;display:flex;flex-direction:column;justify-content:center;align-items:center;font-weight:700;font-size:20px;border-radius:10px;gap:6px;text-align:center;cursor:pointer;}
  @keyframes blink {50%{opacity:0.3}}
  .powered-by {text-align:center;font-size:12px;color:var(--muted);margin-top:6px;font-weight:600;}
</style>
</head>
<body data-theme="light">

<div class="fm-player" id="fm1">
  <div class="top-bar">
    <div class="left-controls">
      <button id="fmPlay">‚ñ∂ Play</button>
      <div class="theme-toggle" id="themeToggle"></div>
    </div>
    <div class="live-card" id="liveStatus"><div class="dot"></div>Live</div>
  </div>

  <div class="controls">
    <div class="title">üéô Hidex Radio</div>
    <div class="subtitle-marquee"><span id="subtitleText">Loading latest update...</span></div>
    <div style="display:flex;gap:10px;align-items:center;margin-top:6px">
      <label for="fmVol">Volume</label>
      <input id="fmVol" type="range" min="0" max="1" step="0.01" value="1">
    </div>
  </div>

  <div class="viz-wrap">
    <canvas id="viz" width="520" height="160"></canvas>
    <div id="overlayOff" class="overlay-off">FM RADIO OFF<small>‚ñ∂ Tap Anywhere to Start</small></div>
  </div>

  <div class="powered-by">Powered by ùóòùó∫ùòÅùó∂ùóÆùóø ùó†ùóÆùó∫ùòÇùóª</div>
</div>

<script>
const streamUrl = "https://as1.digitalsynapsebd.com/proxy/bbdktraf/stream";
const subtitleUrl = "https://raw.githubusercontent.com/gmr375648/adge/refs/heads/main/ban01.json"; // ‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶§‡ßã‡¶Æ‡¶æ‡¶∞ JSON ‡¶´‡¶æ‡¶á‡¶≤‡ßá‡¶∞ ‡¶≤‡¶ø‡¶Ç‡¶ï ‡¶¶‡¶æ‡¶ì
const audio = new Audio(streamUrl);
audio.crossOrigin = "anonymous";
audio.preload = "none";

const btn = document.getElementById('fmPlay');
const vol = document.getElementById('fmVol');
const liveStatus = document.getElementById('liveStatus');
const overlayOff = document.getElementById('overlayOff');
const themeToggle = document.getElementById('themeToggle');
const subtitleText = document.getElementById('subtitleText');
const body = document.body;

let audioCtx = null, analyser = null, sourceNode = null, rafId = null;
const canvas = document.getElementById('viz');
const ctx = canvas.getContext('2d');

function setupAudioContext(){
  if (audioCtx) return;
  audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  analyser = audioCtx.createAnalyser();
  analyser.fftSize = 256;
  analyser.smoothingTimeConstant = 0.85;
  sourceNode = audioCtx.createMediaElementSource(audio);
  sourceNode.connect(analyser);
  analyser.connect(audioCtx.destination);
}

function drawVisualizer(){
  const bufferLength = analyser.frequencyBinCount;
  const dataArray = new Uint8Array(bufferLength);
  analyser.getByteFrequencyData(dataArray);
  ctx.clearRect(0,0,canvas.width,canvas.height);
  const barCount = 40;
  const step = Math.floor(bufferLength / barCount);
  const barWidth = (canvas.width - (barCount-1)*4) / barCount;
  for (let i=0; i<barCount; i++){
    let sum=0;for (let j=0;j<step;j++) sum+=dataArray[i*step+j]||0;
    const avg = sum / step / 255;
    const h = Math.pow(avg,0.6)*canvas.height;
    const x = i*(barWidth+4);
    const y = canvas.height - h;
    ctx.fillStyle = `hsl(${(i/barCount)*360}, 70%, ${40+avg*30}%)`;
    ctx.fillRect(x,y,barWidth,h);
  }
  rafId=requestAnimationFrame(drawVisualizer);
}

async function startPlayback(){
  setupAudioContext();
  if (audioCtx.state === 'suspended') await audioCtx.resume();
  if (audio.paused){
    await audio.play();
    btn.textContent='‚ùö‚ùö Pause';
    overlayOff.style.display='none';
    liveStatus.style.display='flex';
    if (!rafId) drawVisualizer();
  }
}

btn.addEventListener('click',async()=>{
  if(audio.paused){await startPlayback();}
  else{
    audio.pause();btn.textContent='‚ñ∂ Play';
    liveStatus.style.display='none';
    if(rafId){cancelAnimationFrame(rafId);rafId=null;}
    ctx.clearRect(0,0,canvas.width,canvas.height);
    overlayOff.style.display='flex';
  }
});

overlayOff.addEventListener('click',startPlayback);
vol.addEventListener('input',()=>audio.volume=vol.value);

function resizeCanvasToDisplaySize(){
  const dpr=window.devicePixelRatio||1;
  const displayWidth=Math.floor(canvas.clientWidth*dpr);
  const displayHeight=Math.floor(canvas.clientHeight*dpr);
  if(canvas.width!==displayWidth||canvas.height!==displayHeight){
    canvas.width=displayWidth;canvas.height=displayHeight;
  }
}
window.addEventListener('resize',resizeCanvasToDisplaySize);
resizeCanvasToDisplaySize();

window.addEventListener('load',()=>{
  startPlayback().catch(()=>{overlayOff.style.display='flex';});
  fetchSubtitle(); // ‡¶™‡ßç‡¶∞‡¶•‡¶Æ‡¶¨‡¶æ‡¶∞ ‡¶≤‡ßã‡¶°‡ßá‡¶∞ ‡¶∏‡¶Æ‡ßü ‡¶∏‡¶æ‡¶¨‡¶ü‡¶æ‡¶á‡¶ü‡ßá‡¶≤ ‡¶Ü‡¶®‡¶¨‡ßã
  setInterval(fetchSubtitle, 10000); // ‡¶™‡ßç‡¶∞‡¶§‡¶ø 10 ‡¶∏‡ßá‡¶ï‡ßá‡¶®‡ßç‡¶° ‡¶™‡¶∞ ‡¶™‡¶∞ ‡¶®‡¶§‡ßÅ‡¶® ‡¶°‡ßá‡¶ü‡¶æ ‡¶Ü‡¶®‡¶¨‡ßá
});

themeToggle.addEventListener('click',()=>{
  body.dataset.theme = body.dataset.theme==='dark'?'light':'dark';
});

// üî• JSON ‡¶•‡ßá‡¶ï‡ßá subtitle ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®
async function fetchSubtitle(){
  try {
    const res = await fetch(subtitleUrl + "?t=" + Date.now());
    if(!res.ok) throw new Error("Failed to load subtitle");
    const data = await res.json();
    subtitleText.textContent = data.subtitle || "No update available.";
  } catch (err){
    subtitleText.textContent = "Failed to load update.";
  }
}
</script>

</body>
</html>
